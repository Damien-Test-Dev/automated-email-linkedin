name: Daily Linkedin Orchestrator

on:
  schedule:
    - cron: "0 7 * * 1-5"   # 7h UTC = 9h Paris, du lundi au vendredi
  workflow_dispatch:

jobs:
  orchestrate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get today's date (Europe/Paris)
        id: date
        run: |
          TODAY=$(TZ="Europe/Paris" date +%Y-%m-%d)
          echo "today=$TODAY" >> $GITHUB_OUTPUT

      - name: Select post and image with fallback (J-30 backwards window)
        id: select_content
        env:
          TODAY: ${{ steps.date.outputs.today }}
        run: |
          echo "Date du jour : $TODAY"

          # 1) Tester d'abord la date du jour
          POST_TODAY="posts/${TODAY}_post.txt"
          IMAGE_TODAY="images/${TODAY}_image.png"

          if [ -f "$POST_TODAY" ] && [ -f "$IMAGE_TODAY" ]; then
            echo "Utilisation du contenu du jour : $TODAY"
            SELECTED_DATE="$TODAY"
            POST_FILE="$POST_TODAY"
            IMAGE_FILE="$IMAGE_TODAY"
          else
            echo "Contenu du jour incomplet, activation du fallback J-30 en arrière..."

            FOUND_DATE=""

            # 2) Boucle de TODAY-30 à TODAY-59 (fenêtre de 30 jours en arrière)
            for OFFSET in $(seq 30 59); do
              CANDIDATE_DATE=$(date -d "$TODAY -${OFFSET} days" +%Y-%m-%d)
              CANDIDATE_POST="posts/${CANDIDATE_DATE}_post.txt"
              CANDIDATE_IMAGE="images/${CANDIDATE_DATE}_image.png"

              echo "Test du fallback pour la date : $CANDIDATE_DATE"

              if [ -f "$CANDIDATE_POST" ] && [ -f "$CANDIDATE_IMAGE" ]; then
                echo "Contenu fallback trouvé pour la date : $CANDIDATE_DATE"
                FOUND_DATE="$CANDIDATE_DATE"
                POST_FILE="$CANDIDATE_POST"
                IMAGE_FILE="$CANDIDATE_IMAGE"
                break
              fi
            done

            if [ -z "$FOUND_DATE" ]; then
              echo "Aucun contenu valide trouvé dans la fenêtre J-30 à J-59."
              exit 1
            fi

            SELECTED_DATE="$FOUND_DATE"
          fi

          echo "Date réellement utilisée : $SELECTED_DATE"
          echo "Fichier post : $POST_FILE"
          echo "Fichier image : $IMAGE_FILE"

          # 3) Exporter le contenu du post
          CONTENT=$(cat "$POST_FILE")
          echo "post_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # 4) Exporter le chemin de l'image et la date effective
          echo "image_path=$IMAGE_FILE" >> $GITHUB_OUTPUT
          echo "effective_date=$SELECTED_DATE" >> $GITHUB_OUTPUT

      - name: Build raw image URL
        id: image_url
        run: |
          RAW_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/${{ steps.select_content.outputs.image_path }}"
          echo "raw_url=$RAW_URL" >> $GITHUB_OUTPUT

      - name: Select next commit title (infinite rotation)
        id: commit_title
        run: |
          # Lire l'index actuel
          CURRENT_INDEX=$(cat .commit_title_index || echo 0)

          # Nombre total de titres
          TOTAL=$(wc -l < commit_titles.txt)

          # Calcul du prochain index (rotation infinie)
          NEXT_INDEX=$(( (CURRENT_INDEX % TOTAL) + 1 ))

          # Extraire le titre correspondant
          TITLE=$(sed -n "${NEXT_INDEX}p" commit_titles.txt)

          # Exporter le titre
          echo "commit_title=$TITLE" >> $GITHUB_OUTPUT

          # Mettre à jour l'index
          echo "$NEXT_INDEX" > .commit_title_index

      - name: Commit updated index
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add .commit_title_index
          git commit -m "Update commit title index to ${{ steps.commit_title.outputs.commit_title }}" || echo "No changes to commit"
          git push

      - name: Create daily commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Ajouter l'image utilisée (jour ou fallback)
          git add ${{ steps.select_content.outputs.image_path }} || true

          # Construire le commit message
          COMMIT_TITLE="${{ steps.commit_title.outputs.commit_title }}"
          POST_CONTENT="${{ steps.select_content.outputs.post_content }}"
          IMAGE_URL="${{ steps.image_url.outputs.raw_url }}"
          EFFECTIVE_DATE="${{ steps.select_content.outputs.effective_date }}"

          echo "$COMMIT_TITLE" > commit_message.txt
          echo "" >> commit_message.txt
          echo "$POST_CONTENT" >> commit_message.txt
          echo "" >> commit_message.txt
          echo "IMAGE_URL: $IMAGE_URL" >> commit_message.txt
          echo "EFFECTIVE_DATE: $EFFECTIVE_DATE" >> commit_message.txt

          git add commit_message.txt

          git commit --allow-empty -F commit_message.txt
          git push
