name: Daily Linkedin Orchestrator

on:
  schedule:
    - cron: "0 7 * * 1-5"   # 7h UTC = 9h Paris, du lundi au vendredi
  workflow_dispatch:

jobs:
  orchestrate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get today's date (Europe/Paris)
        id: date
        run: |
          TODAY=$(TZ="Europe/Paris" date +%Y-%m-%d)
          echo "today=$TODAY" >> $GITHUB_OUTPUT

      - name: Select today's post
        id: extract_post
        run: |
          FILE="posts/${{ steps.date.outputs.today }}_post.txt"
          if [ ! -f "$FILE" ]; then
            echo "Post introuvable : $FILE"
            exit 1
          fi
          CONTENT=$(cat "$FILE")
          echo "post_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Select today's image
        id: extract_image
        run: |
          FILE="images/${{ steps.date.outputs.today }}_image.png"
          if [ ! -f "$FILE" ]; then
            echo "Image introuvable : $FILE"
            exit 1
          fi
          echo "image_path=$FILE" >> $GITHUB_OUTPUT

      - name: Select weekly commit title
        id: commit_title
        run: |
          WEEK=$(TZ="Europe/Paris" date +%U)
          TOTAL=$(wc -l < commit_titles.txt)
          INDEX=$((10#$WEEK % TOTAL + 1))
          TITLE=$(sed -n "${INDEX}p" commit_titles.txt)
          echo "commit_title=$TITLE" >> $GITHUB_OUTPUT

      - name: Create daily commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Ajouter l'image du jour au commit
          git add images/${{ steps.date.outputs.today }}_image.png

          # Construire le commit message multi-ligne
          cat <<EOF > commit_message.txt
${{ steps.commit_title.outputs.commit_title }}

${{ steps.extract_post.outputs.post_content }}
EOF

          git add commit_message.txt

          git commit -F commit_message.txt
          git push
