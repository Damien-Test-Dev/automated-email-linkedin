name: Orchestrator - publier contenu existant

on:
  schedule:
    # Tous les jours du lundi au vendredi à 9h (heure de Paris)
    # 8h UTC = 9h CET
    - cron: "0 8 * * 1-5"
  workflow_dispatch: {}

jobs:
  publish_existing_content:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Déterminer la date du jour (heure de Paris)
        run: |
          TZ="Europe/Paris" date +"DATE=%Y-%m-%d" >> "$GITHUB_ENV"

      - name: Construire les chemins des fichiers du jour
        run: |
          echo "POST_FILE=docs/posts/${DATE}_post.txt" >> "$GITHUB_ENV"
          echo "IMAGE_FILE=docs/images/${DATE}_image.png" >> "$GITHUB_ENV"

      - name: Vérifier l’existence des fichiers du jour
        run: |
          echo "Date du jour : $DATE"
          echo "Post attendu : $POST_FILE"
          echo "Image attendue : $IMAGE_FILE"

          if [ ! -f "$POST_FILE" ]; then
            echo "⚠ Fichier post introuvable, aucune publication aujourd'hui."
            exit 0
          fi

          if [ ! -f "$IMAGE_FILE" ]; then
            echo "⚠ Fichier image introuvable, aucune publication aujourd'hui."
            exit 0
          fi

          echo "✅ Les deux fichiers existent, on continue."

      - name: Mettre à jour docs/history.json
        run: |
          python << 'PY'
          import json
          from pathlib import Path
          import os

          history_path = Path("docs/history.json")
          date = os.environ["DATE"]
          post_file = os.environ["POST_FILE"].split("/")[-1]
          image_file = os.environ["IMAGE_FILE"].split("/")[-1]

          if not history_path.exists():
            data = {"entries": []}
          else:
            with history_path.open("r", encoding="utf-8") as f:
              data = json.load(f)

          entries = data.get("entries", [])

          # Si une entrée existe déjà pour cette date → on ne duplique pas
          if any(e.get("date") == date for e in entries):
            print(f"Entrée déjà existante pour {date}, aucune modification de history.json.")
          else:
            id_value = f"UCFlow-{date.replace('-', '')}-001"
            new_entry = {
              "date": date,
              "id": id_value,
              "post_file": post_file,
              "image_file": image_file,
            }
            entries.append(new_entry)
            data["entries"] = entries

            with history_path.open("w", encoding="utf-8") as f:
              json.dump(data, f, indent=2, ensure_ascii=False)

            print(f"Nouvelle entrée ajoutée pour {date} : {id_value}")

          PY

      - name: Vérifier s'il y a des changements à committer
        run: |
          if git diff --quiet; then
            echo "Aucun changement à committer."
            exit 0
          fi

      - name: Commit et push des changements
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add docs/history.json

          # Si aucun changement n'est staged → ne pas échouer
          if git diff --cached --quiet; then
            echo "Aucun changement à committer (staging vide)."
            exit 0
          fi

          git commit -m "auto: publication du ${DATE} (contenu existant)"
          git push
