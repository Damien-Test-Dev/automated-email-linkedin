name: Daily Linkedin Orchestrator

on:
  schedule:
    - cron: "0 7 * * 1-5"   # 7h UTC = 9h Paris, du lundi au vendredi
  workflow_dispatch:

jobs:
  orchestrate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get today's date (Europe/Paris)
        id: date
        run: |
          TODAY=$(TZ="Europe/Paris" date +%Y-%m-%d)
          echo "today=$TODAY" >> $GITHUB_OUTPUT

      - name: Select today's post
        id: extract_post
        run: |
          FILE="posts/${{ steps.date.outputs.today }}_post.txt"
          if [ ! -f "$FILE" ]; then
            echo "Post introuvable : $FILE"
            exit 1
          fi
          CONTENT=$(cat "$FILE")
          echo "post_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Select today's image
        id: extract_image
        run: |
          FILE="images/${{ steps.date.outputs.today }}_image.png"
          if [ ! -f "$FILE" ]; then
            echo "Image introuvable : $FILE"
            exit 1
          fi
          echo "image_path=$FILE" >> $GITHUB_OUTPUT

      - name: Build raw image URL
        id: image_url
        run: |
          RAW_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/images/${{ steps.date.outputs.today }}_image.png"
          echo "raw_url=$RAW_URL" >> $GITHUB_OUTPUT

      - name: Select next commit title (infinite rotation)
        id: commit_title
        run: |
          # Lire l'index actuel
          CURRENT_INDEX=$(cat .commit_title_index || echo 0)

          # Nombre total de titres
          TOTAL=$(wc -l < commit_titles.txt)

          # Calcul du prochain index (rotation infinie)
          NEXT_INDEX=$(( (CURRENT_INDEX % TOTAL) + 1 ))

          # Extraire le titre correspondant
          TITLE=$(sed -n "${NEXT_INDEX}p" commit_titles.txt)

          # Exporter le titre
          echo "commit_title=$TITLE" >> $GITHUB_OUTPUT

          # Mettre Ã  jour l'index
          echo "$NEXT_INDEX" > .commit_title_index

      - name: Commit updated index
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add .commit_title_index
          git commit -m "Update commit title index to ${{ steps.commit_title.outputs.commit_title }}" || echo "No changes to commit"
          git push

      - name: Create daily commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Ajouter l'image du jour
          git add images/${{ steps.date.outputs.today }}_image.png || true

          # Construire le commit message
          COMMIT_TITLE="${{ steps.commit_title.outputs.commit_title }}"
          POST_CONTENT="${{ steps.extract_post.outputs.post_content }}"
          IMAGE_URL="${{ steps.image_url.outputs.raw_url }}"

          echo "$COMMIT_TITLE" > commit_message.txt
          echo "" >> commit_message.txt
          echo "$POST_CONTENT" >> commit_message.txt
          echo "" >> commit_message.txt
          echo "IMAGE_URL: $IMAGE_URL" >> commit_message.txt

          git add commit_message.txt

          git commit --allow-empty -F commit_message.txt
          git push
