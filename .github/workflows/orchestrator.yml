name: Orchestrator - publish daily content (Issue-as-Payload)

on:
  schedule:
    # Lun–Ven à 09:05 Paris (DST inclus) via double cron + guard
    # Été (Paris UTC+2)  => 07:05 UTC
    # Hiver (Paris UTC+1)=> 08:05 UTC
    - cron: "5 7 * * 1-5"
    - cron: "5 8 * * 1-5"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  publish:
    runs-on: ubuntu-latest

    concurrency:
      group: ucflow-maintenance
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guard — uniquement Lun–Ven à 09:05 Paris
        run: |
          HHMM=$(TZ="Europe/Paris" date +"%H%M")
          DOW=$(TZ="Europe/Paris" date +"%u") # 1..7
          echo "Paris HHMM: ${HHMM} | DOW: ${DOW}"

          if [ "${DOW}" -gt 5 ]; then
            echo "⏭️ Week-end → stop."
            exit 0
          fi

          if [ "${HHMM}" != "0905" ]; then
            echo "⏭️ Pas 09:05 Paris → stop (run technique DST)."
            exit 0
          fi

      - name: Determine date (Paris)
        run: |
          TZ="Europe/Paris" date +"DATE=%Y-%m-%d" >> "$GITHUB_ENV"
          echo "DATE is $DATE"

      - name: Define expected files
        run: |
          echo "POST_FILE=docs/posts/${DATE}_post.txt" >> "$GITHUB_ENV"
          echo "IMAGE_FILE=docs/images/${DATE}_image.png" >> "$GITHUB_ENV"

      - name: Validate daily content exists and is not empty
        run: |
          set -euo pipefail

          echo "Post:  $POST_FILE"
          echo "Image: $IMAGE_FILE"

          if [ ! -f "$POST_FILE" ]; then
            echo "⏭️ Missing post file → stop."
            exit 0
          fi

          if [ ! -f "$IMAGE_FILE" ]; then
            echo "⏭️ Missing image file → stop."
            exit 0
          fi

          # ✅ Post non vide (évite Issue vide)
          if [ ! -s "$POST_FILE" ]; then
            echo "⏭️ Post is empty → stop."
            exit 0
          fi

          # ✅ Option: post "blanc" (espaces) -> stop
          if [ -z "$(tr -d '[:space:]' < "$POST_FILE")" ]; then
            echo "⏭️ Post contains only whitespace → stop."
            exit 0
          fi

          echo "✅ Daily content OK."

      - name: Build public image URLs (RAW + Pages)
        run: |
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY##*/}"

          IMAGE_URL_RAW="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/docs/images/${DATE}_image.png"
          IMAGE_URL_PAGES="https://${OWNER}.github.io/${REPO}/images/${DATE}_image.png"

          echo "IMAGE_URL_RAW=${IMAGE_URL_RAW}" >> "$GITHUB_ENV"
          echo "IMAGE_URL_PAGES=${IMAGE_URL_PAGES}" >> "$GITHUB_ENV"

          echo "RAW  : ${IMAGE_URL_RAW}"
          echo "PAGES: ${IMAGE_URL_PAGES}"

      - name: Generate payload JSON (archive)
        run: |
          set -euo pipefail
          mkdir -p docs/payload

          python << 'PY'
          import json
          from pathlib import Path
          import os

          date = os.environ["DATE"]
          post_file = os.environ["POST_FILE"]
          image_file = os.environ["IMAGE_FILE"]
          image_url_raw = os.environ["IMAGE_URL_RAW"]
          image_url_pages = os.environ["IMAGE_URL_PAGES"]

          post_text = Path(post_file).read_text(encoding="utf-8").rstrip("\n")
          id_value = f"UCFlow-{date.replace('-', '')}-001"

          payload = {
            "date": date,
            "id": id_value,
            "text": post_text,
            "image_file": image_file,
            "image_url": image_url_raw,
            "image_url_pages": image_url_pages
          }

          out = Path(f"docs/payload/{date}.json")
          out.write_text(json.dumps(payload, indent=2, ensure_ascii=False), encoding="utf-8")
          print(f"✅ Payload generated: {out}")
          PY

      - name: Create Issue (Zapier payload) with label ucflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python << 'PY'
          import os, json, urllib.request

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ["GH_TOKEN"]

          # Title = image URL (Buffer Photo URL)
          title = os.environ["IMAGE_URL_RAW"]

          # Body = full post text (Buffer Text)
          body_path = os.environ["POST_FILE"]
          body = open(body_path, "r", encoding="utf-8").read().rstrip("\n")

          def gh_request(url, method="GET", data=None):
            headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json",
              "X-GitHub-Api-Version": "2022-11-28",
              "User-Agent": "ucflow-orchestrator"
            }
            req = urllib.request.Request(url, headers=headers, method=method)
            if data is not None:
              req.data = data
            with urllib.request.urlopen(req) as r:
              return json.loads(r.read().decode("utf-8"))

          # Anti-dup: if title already exists (same image URL), skip
          issues = gh_request(f"https://api.github.com/repos/{repo}/issues?state=all&per_page=100")
          issues = [i for i in issues if "pull_request" not in i]

          if any(i.get("title") == title for i in issues):
            print("ℹ️ Issue already exists (same title) → skip.")
            raise SystemExit(0)

          payload = json.dumps({
            "title": title,
            "body": body,
            "labels": ["ucflow"]
          }).encode("utf-8")

          created = gh_request(f"https://api.github.com/repos/{repo}/issues", method="POST", data=payload)
          print("✅ Issue created:", created.get("html_url"))
          PY

      - name: Commit and push payload (if changed)
        run: |
          set -e

          if git status --porcelain | grep -q .; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add docs/payload/
            git commit -m "auto: payload ${DATE}"
            git push
          else
            echo "No changes to commit."
          fi
