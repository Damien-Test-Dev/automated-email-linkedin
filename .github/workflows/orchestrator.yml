name: Ultra Cosmic Flow — Orchestrator

on:
  schedule:
    - cron: "55 8 * * 1-5"   # Tous les jours à 08:55, du lundi au vendredi
  workflow_dispatch:         # Permet de lancer manuellement

jobs:
  generate_publication:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate post + image (LinkedIn format)
        run: |
          DATE=$(date +'%Y-%m-%d')
          POST_FILE="docs/posts/${DATE}_post.txt"
          IMAGE_FILE="docs/images/${DATE}_image.png"

          echo "Génération du post : $POST_FILE"
          echo "Post du $DATE" > $POST_FILE
          echo "" >> $POST_FILE
          echo "Ceci est un post généré automatiquement par l'orchestrateur Ultra Cosmic Flow." >> $POST_FILE

          echo "Génération de l'image LinkedIn : $IMAGE_FILE"
          convert -size 1200x627 xc:white \
            -gravity center \
            -pointsize 48 \
            -annotate 0 "Image du $DATE" \
            $IMAGE_FILE

      - name: Update history.json
        run: |
          DATE=$(date +'%Y-%m-%d')
          ID="UCFlow-${DATE//-/}-001"
          POST_FILE="${DATE}_post.txt"
          IMAGE_FILE="${DATE}_image.png"

          echo "Mise à jour de history.json"

          TMP=$(mktemp)
          jq --arg date "$DATE" \
             --arg id "$ID" \
             --arg post "$POST_FILE" \
             --arg image "$IMAGE_FILE" \
             '.entries += [{"date": $date, "id": $id, "post_file": $post, "image_file": $image}]' \
             docs/history.json > "$TMP"

          mv "$TMP" docs/history.json

      - name: Commit and push changes
        run: |
          git config --global user.name "Ultra Cosmic Flow Bot"
          git config --global user.email "bot@example.com"

          git add .
          git commit -m "auto: publication du $DATE (format LinkedIn)"
          git push
