name: Rename post files with dates

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Date de départ au format YYYY-MM-DD (ex: 2025-01-13)"
        required: true
        default: "2025-01-13"

jobs:
  rename-posts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List current files in /posts
        run: |
          echo "Fichiers actuels dans /posts :"
          ls -la posts || echo "Aucun dossier posts trouvé"

      - name: Rename raw post files to YYYY-MM-DD_post.txt (weekdays only)
        run: |
          set -e

          START_DATE="${{ github.event.inputs.start_date }}"
          echo "Date de départ fournie : $START_DATE"

          # Contrôle basique du format
          if ! date -d "$START_DATE" "+%Y-%m-%d" >/dev/null 2>&1; then
            echo "Erreur : format de date invalide. Utilise YYYY-MM-DD."
            exit 1
          fi

          # Récupération de la liste des fichiers dans /posts qui ne sont pas déjà au bon format
          cd posts

          echo "Fichiers trouvés dans /posts avant filtrage :"
          ls -1

          RAW_FILES=()
          while IFS= read -r file; do
            # Ignorer .gitkeep
            if [ "$file" = ".gitkeep" ]; then
              continue
            fi
            # Ignorer les fichiers déjà au format YYYY-MM-DD_post.txt
            if echo "$file" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}_post\.txt$'; then
              echo "Skip (déjà au bon format) : $file"
              continue
            fi
            RAW_FILES+=("$file")
          done < <(ls -1)

          echo "Fichiers à renommer : ${RAW_FILES[*]}"

          CURRENT_DATE="$START_DATE"

          for file in "${RAW_FILES[@]}"; do
            # Avancer la date jusqu'à un jour de semaine (lundi=1 ... vendredi=5)
            while true; do
              DAY_OF_WEEK=$(date -d "$CURRENT_DATE" +%u)
              if [ "$DAY_OF_WEEK" -le 5 ]; then
                break
              fi
              CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
            done

            NEW_NAME="${CURRENT_DATE}_post.txt"

            echo "Renommage : $file  ->  $NEW_NAME"
            mv "$file" "$NEW_NAME"

            # Passer au jour suivant
            CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
          done

          echo "Fichiers finaux dans /posts :"
          ls -1

      - name: Commit and push renamed files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git status

          if git diff --quiet && git diff --cached --quiet; then
            echo "Aucun changement à committer."
            exit 0
          fi

          git add posts

          COMMIT_MESSAGE="⭐ Auto-rename post files to YYYY-MM-DD_post.txt ⭐"
          git commit -m "$COMMIT_MESSAGE"
          git push

