name: Ultra Cosmic Flow Codex (History)

on:
  workflow_dispatch:
    inputs:
      date:
        description: "Date du post publiÃ© (format YYYY-MM-DD)"
        required: true
        type: string

jobs:
  update-history:
    name: Update history.json for published post
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare variables
        id: prep
        run: |
          set -e

          DATE_INPUT="${{ github.event.inputs.date }}"
          echo "ðŸ“… Date reÃ§ue : $DATE_INPUT"

          POSTS_DIR="posts"
          IMAGES_DIR="images"
          HISTORY_FILE="history.json"

          POST_FILE="${POSTS_DIR}/${DATE_INPUT}_post.txt"
          IMAGE_FILE="${IMAGES_DIR}/${DATE_INPUT}_image.png"

          if [ ! -f "$POST_FILE" ]; then
            echo "âŒ Fichier post introuvable : $POST_FILE"
            exit 1
          fi

          if [ ! -f "$IMAGE_FILE" ]; then
            echo "âŒ Fichier image introuvable : $IMAGE_FILE"
            exit 1
          fi

          echo "post_file=$POST_FILE" >> "$GITHUB_OUTPUT"
          echo "image_file=$IMAGE_FILE" >> "$GITHUB_OUTPUT"
          echo "history_file=$HISTORY_FILE" >> "$GITHUB_OUTPUT"
          echo "date=$DATE_INPUT" >> "$GITHUB_OUTPUT"

      - name: Ensure history.json exists
        run: |
          HISTORY_FILE="${{ steps.prep.outputs.history_file }}"

          if [ ! -f "$HISTORY_FILE" ]; then
            echo "ðŸ“˜ history.json introuvable, crÃ©ation..."
            cat > "$HISTORY_FILE" << 'EOF'
{
  "entries": []
}
EOF
          else
            echo "ðŸ“˜ history.json trouvÃ©."
          fi

      - name: Check if date already exists in history
        id: check
        run: |
          set -e
          HISTORY_FILE="${{ steps.prep.outputs.history_file }}"
          DATE_INPUT="${{ steps.prep.outputs.date }}"

          EXISTS=$(jq --arg d "$DATE_INPUT" '.entries[]? | select(.date == $d) | .date' "$HISTORY_FILE" || true)

          if [ -n "$EXISTS" ]; then
            echo "âš ï¸ Une entrÃ©e existe dÃ©jÃ  pour la date $DATE_INPUT. Aucune mise Ã  jour."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… Aucune entrÃ©e existante pour la date $DATE_INPUT."
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract first two lines of post
        if: steps.check.outputs.skip == 'false'
        id: extract
        run: |
          set -e
          POST_FILE="${{ steps.prep.outputs.post_file }}"

          echo "ðŸ“„ Extraction des deux premiÃ¨res lignes de : $POST_FILE"

          # Lire les deux premiÃ¨res lignes, gÃ©rer les fichiers courts
          TITLE_LINES=$(head -n 2 "$POST_FILE" | sed 's/"/\\"/g')

          if [ -z "$TITLE_LINES" ]; then
            echo "âš ï¸ Le post est vide ou ne contient pas de texte exploitable."
            TITLE_LINES="(Titre indisponible)"
          fi

          # Remplacer les retours Ã  la ligne par \n pour JSON
          TITLE_JSON=$(printf '%s\n' "$TITLE_LINES" | awk 'BEGIN{ORS="\\n"} {print}' | sed 's/\\n$//')

          echo "title=$TITLE_JSON" >> "$GITHUB_OUTPUT"

      - name: Generate unique ID for entry
        if: steps.check.outputs.skip == 'false'
        id: genid
        run: |
          set -e
          HISTORY_FILE="${{ steps.prep.outputs.history_file }}"
          DATE_INPUT="${{ steps.prep.outputs.date }}"

          # Compter les entrÃ©es existantes pour cette date
          COUNT_FOR_DATE=$(jq --arg d "$DATE_INPUT" '[.entries[]? | select(.date == $d)] | length' "$HISTORY_FILE")
          INDEX=$((COUNT_FOR_DATE + 1))

          DATE_COMPACT=$(echo "$DATE_INPUT" | tr -d '-')
          ID=$(printf "UCFlow-%s-%03d" "$DATE_COMPACT" "$INDEX")

          echo "ðŸ†” ID gÃ©nÃ©rÃ© : $ID"
          echo "id=$ID" >> "$GITHUB_OUTPUT"

      - name: Append entry to history.json
        if: steps.check.outputs.skip == 'false'
        run: |
          set -e

          HISTORY_FILE="${{ steps.prep.outputs.history_file }}"
          DATE_INPUT="${{ steps.prep.outputs.date }}"
          POST_FILE_BASENAME="$(basename "${{ steps.prep.outputs.post_file }}")"
          IMAGE_FILE_BASENAME="$(basename "${{ steps.prep.outputs.image_file }}")"
          TITLE="${{ steps.extract.outputs.title }}"
          ID="${{ steps.genid.outputs.id }}"

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "ðŸ“ Ajout d'une entrÃ©e dans $HISTORY_FILE"

          TMP_FILE="${HISTORY_FILE}.tmp"

          jq --arg date "$DATE_INPUT" \
             --arg post_file "$POST_FILE_BASENAME" \
             --arg image_file "$IMAGE_FILE_BASENAME" \
             --arg title "$TITLE" \
             --arg timestamp "$TIMESTAMP" \
             --arg id "$ID" \
             '.entries += [{
                "date": $date,
                "post_file": $post_file,
                "image_file": $image_file,
                "title": $title,
                "timestamp": $timestamp,
                "id": $id
              }]' "$HISTORY_FILE" > "$TMP_FILE"

          mv "$TMP_FILE" "$HISTORY_FILE"

          echo "âœ… history.json mis Ã  jour."

      - name: Commit and push changes
        if: steps.check.outputs.skip == 'false'
        run: |
          set -e

          if git diff --quiet; then
            echo "âœ… Aucun changement Ã  committer."
            exit 0
          fi

          DATE_INPUT="${{ steps.prep.outputs.date }}"
          COMMIT_MESSAGE="Ultra Cosmic Flow: update history for ${DATE_INPUT}"

          echo "ðŸš€ Commit : $COMMIT_MESSAGE"
          git add history.json
          git commit -m "$COMMIT_MESSAGE"
          git push
