name: Ultra Cosmic Flow Codex (History)

on:
  workflow_dispatch:
    inputs:
      date:
        description: "Date du post publié (format YYYY-MM-DD)"
        required: true
        type: string

jobs:
  update-history:
    name: Update history.json for published post
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare variables
        id: prep
        run: |
          set -e

          DATE_INPUT="${{ github.event.inputs.date }}"
          echo "Date reçue : $DATE_INPUT"

          POSTS_DIR="posts"
          IMAGES_DIR="images"
          HISTORY_FILE="history.json"

          POST_FILE="${POSTS_DIR}/${DATE_INPUT}_post.txt"
          IMAGE_FILE="${IMAGES_DIR}/${DATE_INPUT}_image.png"

          if [ ! -f "$POST_FILE" ]; then
            echo "Fichier post introuvable : $POST_FILE"
            exit 1
          fi

          if [ ! -f "$IMAGE_FILE" ]; then
            echo "Fichier image introuvable : $IMAGE_FILE"
            exit 1
          fi

          echo "post_file=$POST_FILE" >> "$GITHUB_OUTPUT"
          echo "image_file=$IMAGE_FILE" >> "$GITHUB_OUTPUT"
          echo "history_file=$HISTORY_FILE" >> "$GITHUB_OUTPUT"
          echo "date=$DATE_INPUT" >> "$GITHUB_OUTPUT"

      - name: Ensure history.json exists
        run: |
          HISTORY_FILE="${{ steps.prep.outputs.history_file }}"

          if [ ! -f "$HISTORY_FILE" ]; then
            echo "Création de history.json..."
            echo '{"entries":[]}' > "$HISTORY_FILE"
          else
            echo "history.json trouvé."
          fi

      - name: Check if date already exists in history
        id: check
        run: |
          set -e
          HISTORY_FILE="${{ steps.prep.outputs.history_file }}"
          DATE_INPUT="${{ steps.prep.outputs.date }}"

          EXISTS=$(jq --arg d "$DATE_INPUT" '.entries[]? | select(.date == $d)' "$HISTORY_FILE" || true)

          if [ -n "$EXISTS" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract first two lines of post
        if: steps.check.outputs.skip == 'false'
        id: extract
        run: |
          set -e
          POST_FILE="${{ steps.prep.outputs.post_file }}"

          TITLE_LINES=$(head -n 2 "$POST_FILE" | sed 's/"/\\"/g')

          if [ -z "$TITLE_LINES" ]; then
            TITLE_LINES="(Titre indisponible)"
          fi

          TITLE_JSON=$(printf '%s\n' "$TITLE_LINES" | awk 'BEGIN{ORS="\\n"} {print}' | sed 's/\\n$//')

          echo "title=$TITLE_JSON" >> "$GITHUB_OUTPUT"

      - name: Generate unique ID for entry
        if: steps.check.outputs.skip == 'false'
        id: genid
        run: |
          set -e
          HISTORY_FILE="${{ steps.prep.outputs.history_file }}"
          DATE_INPUT="${{ steps.prep.outputs.date }}"

          COUNT_FOR_DATE=$(jq --arg d "$DATE_INPUT" '[.entries[]? | select(.date == $d)] | length' "$HISTORY_FILE")
          INDEX=$((COUNT_FOR_DATE + 1))

          DATE_COMPACT=$(echo "$DATE_INPUT" | tr -d '-')
          ID=$(printf "UCFlow-%s-%03d" "$DATE_COMPACT" "$INDEX")

          echo "id=$ID" >> "$GITHUB_OUTPUT"

      - name: Append entry to history.json
        if: steps.check.outputs.skip == 'false'
        run: |
          set -e

          HISTORY_FILE="${{ steps.prep.outputs.history_file }}"
          DATE_INPUT="${{ steps.prep.outputs.date }}"
          POST_FILE_BASENAME="$(basename "${{ steps.prep.outputs.post_file }}")"
          IMAGE_FILE_BASENAME="$(basename "${{ steps.prep.outputs.image_file }}")"
          TITLE="${{ steps.extract.outputs.title }}"
          ID="${{ steps.genid.outputs.id }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          TMP_FILE="${HISTORY_FILE}.tmp"

          jq --arg date "$DATE_INPUT" \
             --arg post "$POST_FILE_BASENAME" \
             --arg img "$IMAGE_FILE_BASENAME" \
             --arg title "$TITLE" \
             --arg ts "$TIMESTAMP" \
             --arg id "$ID" \
             '.entries += [{
                "date": $date,
                "post_file": $post,
                "image_file": $img,
                "title": $title,
                "timestamp": $ts,
                "id": $id
              }]' "$HISTORY_FILE" > "$TMP_FILE"

          mv "$TMP_FILE" "$HISTORY_FILE"

      - name: Commit and push changes
        if: steps.check.outputs.skip == 'false'
        run: |
          set -e

          if git diff --quiet; then
            exit 0
          fi

          DATE_INPUT="${{ steps.prep.outputs.date }}"
          git add history.json
          git commit -m "Ultra Cosmic Flow: update history for ${DATE_INPUT}"
          git push
