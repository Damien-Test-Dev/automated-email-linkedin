name: Rename all posts and images (Weekend 10:00 Paris + Manual)

on:
  schedule:
    # Objectif: 10:00 heure de Paris, uniquement Sam‚ÄìDim, DST inclus
    # √ât√© (Paris UTC+2)  => 08:00 UTC
    # Hiver (Paris UTC+1)=> 09:00 UTC
    - cron: "0 8 * * 6,0"
    - cron: "0 9 * * 6,0"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  rename-all:
    runs-on: ubuntu-latest

    concurrency:
      group: ucflow-maintenance
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guard ‚Äî uniquement Week-end √† 10h Paris (schedule) / toujours OK en manuel
        if: ${{ github.event_name == 'schedule' }}
        run: |
          set -euo pipefail
          HOUR_PARIS=$(TZ="Europe/Paris" date +"%H")
          DOW_PARIS=$(TZ="Europe/Paris" date +"%u") # 1..7 (1=Lun, 6=Sam, 7=Dim)

          echo "Heure Paris: ${HOUR_PARIS}"
          echo "Jour Paris : ${DOW_PARIS}"

          if [ "${DOW_PARIS}" -le 5 ]; then
            echo "‚è≠Ô∏è Pas le week-end ‚Üí stop."
            exit 0
          fi

          if [ "${HOUR_PARIS}" != "10" ]; then
            echo "‚è≠Ô∏è Pas 10h Paris ‚Üí stop (run technique DST)."
            exit 0
          fi

      - name: Install image conversion tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Prepare report directory
        run: |
          mkdir -p docs/reports
          echo "# Rapport de renommage et conversion" > docs/reports/rename_report.md
          echo "G√©n√©r√© le $(TZ="Europe/Paris" date)" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

      - name: Rename (pairs + fill gaps) + PNG conversion
        run: |
          set -euo pipefail

          echo "## Contexte" >> docs/reports/rename_report.md
          echo "- Run: $(TZ="Europe/Paris" date)" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # Date automatique = demain (base de planification)
          ###############################################
          START_DATE=$(TZ="Europe/Paris" date -d "+1 day" "+%Y-%m-%d")
          echo "## Date de d√©part (pairs): $START_DATE" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # Helpers
          ###############################################
          next_business_day() {
            local d="$1"
            while true; do
              local dow
              dow=$(date -d "$d" +%u) # 1..7
              if [ "$dow" -le 5 ]; then
                echo "$d"
                return
              fi
              d=$(date -d "$d + 1 day" +%Y-%m-%d)
            done
          }

          next_day() {
            date -d "$1 + 1 day" +%Y-%m-%d
          }

          ###############################################
          # 1) Conversion images -> PNG (avant renommage)
          ###############################################
          echo "## Conversion images ‚Üí PNG" >> docs/reports/rename_report.md

          cd docs/images
          find . -maxdepth 1 -type f ! -name ".gitkeep" -print0 | \
          while IFS= read -r -d '' img; do
            img="${img#./}"
            ext="${img##*.}"
            ext_lc="$(echo "$ext" | tr '[:upper:]' '[:lower:]')"
            base="${img%.*}"

            if [[ "$ext_lc" =~ ^(jpg|jpeg|webp)$ ]]; then
              echo "- üñºÔ∏è $img ‚Üí ${base}.png" >> ../reports/rename_report.md
              convert -- "$img" "${base}.png"
              rm -- "$img"
            fi
          done
          cd - > /dev/null
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # 2) Renommage par paires pour fichiers NON conformes
          #    (si tu drop des drafts non dat√©s c√¥t√© posts + images)
          ###############################################
          echo "## Renommage par paires (fichiers non conformes)" >> docs/reports/rename_report.md

          mapfile -d '' -t POSTS_NONCONF < <(
            find docs/posts -maxdepth 1 -type f ! -name ".gitkeep" \
              ! -regextype posix-extended -regex '.*/[0-9]{4}-[0-9]{2}-[0-9]{2}_post\.txt' \
              -print0 | sort -z
          )

          mapfile -d '' -t IMAGES_NONCONF < <(
            find docs/images -maxdepth 1 -type f ! -name ".gitkeep" \
              ! -regextype posix-extended -regex '.*/[0-9]{4}-[0-9]{2}-[0-9]{2}_image\.png' \
              -print0 | sort -z
          )

          echo "- üìù Posts non conformes: ${#POSTS_NONCONF[@]}" >> docs/reports/rename_report.md
          echo "- üñºÔ∏è Images non conformes: ${#IMAGES_NONCONF[@]}" >> docs/reports/rename_report.md

          # Si tu as des drafts post+image non dat√©s, on exige un pairing strict
          if [ "${#POSTS_NONCONF[@]}" -gt 0 ] || [ "${#IMAGES_NONCONF[@]}" -gt 0 ]; then
            if [ "${#POSTS_NONCONF[@]}" -ne "${#IMAGES_NONCONF[@]}" ]; then
              echo "" >> docs/reports/rename_report.md
              echo "‚ùå D√©salignement NON CONFORMES: ${#POSTS_NONCONF[@]} posts vs ${#IMAGES_NONCONF[@]} images" >> docs/reports/rename_report.md
              echo "‚û°Ô∏è Stop pour √©viter de casser le calendrier." >> docs/reports/rename_report.md
              exit 1
            fi

            CURRENT_DATE="$START_DATE"
            for idx in "${!POSTS_NONCONF[@]}"; do
              CURRENT_DATE=$(next_business_day "$CURRENT_DATE")

              post="${POSTS_NONCONF[$idx]}"
              img="${IMAGES_NONCONF[$idx]}"

              post_name="${post##*/}"
              img_name="${img##*/}"

              target_post="docs/posts/${CURRENT_DATE}_post.txt"
              target_img="docs/images/${CURRENT_DATE}_image.png"

              while [ -f "$target_post" ] || [ -f "$target_img" ]; do
                CURRENT_DATE=$(next_day "$CURRENT_DATE")
                CURRENT_DATE=$(next_business_day "$CURRENT_DATE")
                target_post="docs/posts/${CURRENT_DATE}_post.txt"
                target_img="docs/images/${CURRENT_DATE}_image.png"
              done

              echo "- üîÑ Pair(nonconforme) $((idx+1))" >> docs/reports/rename_report.md
              echo "  - üìù $post_name ‚Üí ${CURRENT_DATE}_post.txt" >> docs/reports/rename_report.md
              echo "  - üñºÔ∏è $img_name ‚Üí ${CURRENT_DATE}_image.png" >> docs/reports/rename_report.md

              mv -- "$post" "$target_post"
              mv -- "$img"  "$target_img"

              CURRENT_DATE=$(next_day "$CURRENT_DATE")
            done
          else
            echo "- ‚úÖ Aucun fichier non conforme √† renommer par paires." >> docs/reports/rename_report.md
          fi

          echo "" >> docs/reports/rename_report.md

          ###############################################
          # 3) Remplir les trous: posts dat√©s sans image dat√©e
          ###############################################
          echo "## Remplissage des trous (posts dat√©s sans image)" >> docs/reports/rename_report.md

          # Dates posts conformes
          mapfile -t POST_DATES < <(
            ls -1 docs/posts/[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]_post.txt 2>/dev/null \
              | sed -E 's|.*/([0-9]{4}-[0-9]{2}-[0-9]{2})_post\.txt|\1|' \
              | sort
          )

          # Dates images conformes
          mapfile -t IMG_DATES < <(
            ls -1 docs/images/[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]_image.png 2>/dev/null \
              | sed -E 's|.*/([0-9]{4}-[0-9]{2}-[0-9]{2})_image\.png|\1|' \
              | sort
          )

          # Dates manquantes = dates pr√©sentes dans posts mais pas dans images
          mapfile -t MISSING_DATES < <(
            comm -23 <(printf "%s\n" "${POST_DATES[@]}") <(printf "%s\n" "${IMG_DATES[@]}")
          )

          echo "- üìÖ Dates post sans image: ${#MISSING_DATES[@]}" >> docs/reports/rename_report.md

          # Images non assign√©es = images NON conformes restantes
          mapfile -d '' -t UNASSIGNED < <(
            find docs/images -maxdepth 1 -type f ! -name ".gitkeep" \
              ! -regextype posix-extended -regex '.*/[0-9]{4}-[0-9]{2}-[0-9]{2}_image\.png' \
              -print0 | sort -z
          )

          echo "- üñºÔ∏è Images non assign√©es dispo: ${#UNASSIGNED[@]}" >> docs/reports/rename_report.md

          if [ "${#MISSING_DATES[@]}" -eq 0 ]; then
            echo "- ‚úÖ Aucun trou √† combler." >> docs/reports/rename_report.md
          else
            if [ "${#UNASSIGNED[@]}" -lt "${#MISSING_DATES[@]}" ]; then
              echo "‚ùå Pas assez d'images non assign√©es pour combler les dates manquantes." >> docs/reports/rename_report.md
              echo "‚û°Ô∏è Ajoute des images, puis relance le workflow (manuel)." >> docs/reports/rename_report.md
              exit 1
            fi

            for idx in "${!MISSING_DATES[@]}"; do
              d="${MISSING_DATES[$idx]}"
              img="${UNASSIGNED[$idx]}"
              img_name="${img##*/}"
              target="docs/images/${d}_image.png"

              echo "- üîß Fill gap: $img_name ‚Üí ${d}_image.png" >> docs/reports/rename_report.md
              mv -- "$img" "$target"
            done

            # Si extras, on les laisse, mais on le note
            if [ "${#UNASSIGNED[@]}" -gt "${#MISSING_DATES[@]}" ]; then
              EXTRA=$(( ${#UNASSIGNED[@]} - ${#MISSING_DATES[@]} ))
              echo "- ‚ÑπÔ∏è Images non assign√©es restantes: ${EXTRA} (laiss√©es telles quelles)" >> docs/reports/rename_report.md
            fi
          fi

          echo "" >> docs/reports/rename_report.md
          echo "‚úÖ Workflow rename termin√©." >> docs/reports/rename_report.md

      - name: Commit and push changes
        run: |
          set -euo pipefail

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -q .; then
            git add docs/posts docs/images docs/reports/rename_report.md
            git commit -m "chore: rename posts/images + fill missing image dates"
            git push
          else
            echo "Aucun changement √† committer."
          fi
