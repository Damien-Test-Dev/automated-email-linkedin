name: Rename all posts and images (Weekend 10:00 Paris + Manual)

on:
  schedule:
    # Objectif: 10:00 heure de Paris, uniquement Samâ€“Dim, DST inclus
    # Ã‰tÃ© (Paris UTC+2)  => 08:00 UTC
    # Hiver (Paris UTC+1)=> 09:00 UTC
    - cron: "0 8 * * 6,0"
    - cron: "0 9 * * 6,0"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  rename-all:
    runs-on: ubuntu-latest

    concurrency:
      group: ucflow-maintenance
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guard â€” uniquement Week-end Ã  10h Paris (schedule) / toujours OK en manuel
        if: ${{ github.event_name == 'schedule' }}
        run: |
          set -euo pipefail
          HOUR_PARIS=$(TZ="Europe/Paris" date +"%H")
          DOW_PARIS=$(TZ="Europe/Paris" date +"%u") # 1..7 (6=Sam,7=Dim)

          echo "Heure Paris: ${HOUR_PARIS} | Jour Paris: ${DOW_PARIS}"

          if [ "${DOW_PARIS}" -le 5 ]; then
            echo "â­ï¸ Pas le week-end â†’ stop."
            exit 0
          fi

          if [ "${HOUR_PARIS}" != "10" ]; then
            echo "â­ï¸ Pas 10h Paris â†’ stop (run technique DST)."
            exit 0
          fi

      - name: Install image conversion tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Prepare report directory
        run: |
          mkdir -p docs/reports
          echo "# Rapport de renommage & alignement" > docs/reports/rename_report.md
          echo "GÃ©nÃ©rÃ© le $(TZ="Europe/Paris" date)" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

      - name: Rename logic (robust) â€” convert + fill gaps + (optional) draft pairs
        run: |
          set -euo pipefail
          python3 << 'PY'
          from __future__ import annotations

          import re
          import sys
          import subprocess
          from pathlib import Path
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo

          ROOT = Path(".")
          POSTS_DIR = ROOT / "docs" / "posts"
          IMAGES_DIR = ROOT / "docs" / "images"
          REPORT = ROOT / "docs" / "reports" / "rename_report.md"

          dated_post_re = re.compile(r"^(\d{4}-\d{2}-\d{2})_post\.txt$")
          dated_img_re  = re.compile(r"^(\d{4}-\d{2}-\d{2})_image\.png$")

          def log(msg: str) -> None:
            print(msg)
            REPORT.write_text(REPORT.read_text(encoding="utf-8") + msg + "\n", encoding="utf-8")

          def list_files(d: Path) -> list[Path]:
            if not d.exists():
              return []
            return sorted([p for p in d.iterdir() if p.is_file() and p.name != ".gitkeep"], key=lambda p: p.name)

          def paris_today() -> datetime:
            return datetime.now(ZoneInfo("Europe/Paris"))

          def next_business_day(d: datetime) -> datetime:
            # 0=Mon..6=Sun ; business = Mon..Fri
            while d.weekday() >= 5:
              d += timedelta(days=1)
            return d

          # --- Header
          log("## Contexte")
          log(f"- Run: {paris_today().isoformat(timespec='seconds')}")
          log("")

          # --- 1) Convert images to PNG where needed
          log("## 1) Conversion images â†’ PNG (si besoin)")
          converted = 0

          for img in list_files(IMAGES_DIR):
            ext = img.suffix.lower()
            if ext in [".jpg", ".jpeg", ".webp"]:
              target = img.with_suffix(".png")
              log(f"- ğŸ–¼ï¸ convert: {img.name} â†’ {target.name}")
              subprocess.run(["convert", str(img), str(target)], check=True)
              img.unlink()
              converted += 1

          if converted == 0:
            log("- âœ… aucune conversion nÃ©cessaire")
          log("")

          # Re-scan after conversion
          posts_files  = list_files(POSTS_DIR)
          images_files = list_files(IMAGES_DIR)

          # --- 2) Build maps of dated posts/images
          posts_by_date: dict[str, Path] = {}
          imgs_by_date: dict[str, Path] = {}

          for p in posts_files:
            m = dated_post_re.match(p.name)
            if m:
              posts_by_date[m.group(1)] = p

          for i in images_files:
            m = dated_img_re.match(i.name)
            if m:
              imgs_by_date[m.group(1)] = i

          post_dates = sorted(posts_by_date.keys())
          img_dates  = sorted(imgs_by_date.keys())

          # Unassigned images = not dated-image.png
          unassigned_images = [p for p in images_files if not dated_img_re.match(p.name)]

          # Missing dates = dates with a post but no image
          missing_dates = [d for d in post_dates if d not in imgs_by_date]

          log("## 2) Diagnostic")
          log(f"- ğŸ“ posts datÃ©s: {len(post_dates)}")
          log(f"- ğŸ–¼ï¸ images datÃ©es: {len(img_dates)}")
          log(f"- ğŸ§© dates post sans image: {len(missing_dates)}")
          log(f"- ğŸ“¦ images non assignÃ©es (non datÃ©es): {len(unassigned_images)}")
          log("")

          # --- 3) Fill gaps: rename unassigned images to missing post dates
          log("## 3) Remplissage des trous (post datÃ© sans image)")
          if len(missing_dates) == 0:
            log("- âœ… aucun trou Ã  combler")
          else:
            if len(unassigned_images) < len(missing_dates):
              log("âŒ Pas assez d'images non assignÃ©es pour combler les dates manquantes.")
              log("â¡ï¸ Ajoute des images (ou supprime des posts) puis relance.")
              sys.exit(1)

            # Stable pairing: missing dates in chronological order, images by filename order
            for d, img in zip(missing_dates, unassigned_images):
              target = IMAGES_DIR / f"{d}_image.png"
              if target.exists():
                log(f"âŒ cible dÃ©jÃ  existante: {target.name} (stop sÃ©curitÃ©)")
                sys.exit(1)
              log(f"- ğŸ”§ fill-gap: {img.name} â†’ {target.name}")
              img.rename(target)

            log("- âœ… trous comblÃ©s")

          log("")

          # --- 4) Optional: if you ever drop NON-dated posts, pair-rename them with remaining unassigned images
          # (This keeps the old 'pairs strict' behavior, but only triggers when posts drafts exist.)
          log("## 4) Draft pairs (uniquement si posts non datÃ©s existent)")

          # Re-scan after fill-gap
          posts_files  = list_files(POSTS_DIR)
          images_files = list_files(IMAGES_DIR)

          draft_posts = [p for p in posts_files if not dated_post_re.match(p.name)]
          draft_images = [p for p in images_files if not dated_img_re.match(p.name)]

          log(f"- ğŸ“ drafts posts: {len(draft_posts)}")
          log(f"- ğŸ–¼ï¸ drafts images: {len(draft_images)}")

          if len(draft_posts) == 0:
            log("- âœ… aucun post draft â†’ skip")
            log("")
            log("âœ… TerminÃ©.")
            sys.exit(0)

          if len(draft_images) < len(draft_posts):
            log("âŒ posts drafts prÃ©sents mais pas assez d'images drafts pour faire des paires.")
            log("â¡ï¸ Ajoute des images drafts puis relance.")
            sys.exit(1)

          start = paris_today().date() + timedelta(days=1)
          cur = datetime.combine(start, datetime.min.time(), tzinfo=ZoneInfo("Europe/Paris"))

          for idx in range(len(draft_posts)):
            cur = next_business_day(cur)
            d = cur.date().isoformat()

            post_src = draft_posts[idx]
            img_src  = draft_images[idx]

            post_dst = POSTS_DIR / f"{d}_post.txt"
            img_dst  = IMAGES_DIR / f"{d}_image.png"

            # If already used, move forward until free
            while post_dst.exists() or img_dst.exists():
              cur += timedelta(days=1)
              cur = next_business_day(cur)
              d = cur.date().isoformat()
              post_dst = POSTS_DIR / f"{d}_post.txt"
              img_dst  = IMAGES_DIR / f"{d}_image.png"

            log(f"- ğŸ”„ pair-draft #{idx+1}: {post_src.name} â†’ {post_dst.name} | {img_src.name} â†’ {img_dst.name}")
            post_src.rename(post_dst)
            img_src.rename(img_dst)

            cur += timedelta(days=1)

          log("")
          log("âœ… TerminÃ©.")
          PY

      - name: Commit and push changes (if any)
        run: |
          set -euo pipefail

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -q .; then
            git add docs/posts docs/images docs/reports/rename_report.md
            git commit -m "chore: rename/fill-gaps posts-images + report"
            git push
          else
            echo "Aucun changement Ã  committer."
          fi
