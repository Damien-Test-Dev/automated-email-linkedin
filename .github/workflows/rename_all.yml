name: Rename all posts and images (Weekend 10:00 Paris + Manual)

on:
  schedule:
    # Objectif: 10:00 heure de Paris, uniquement Samâ€“Dim, DST inclus
    # Ã‰tÃ© (Paris UTC+2)  => 08:00 UTC
    # Hiver (Paris UTC+1)=> 09:00 UTC
    - cron: "0 8 * * 6,0"
    - cron: "0 9 * * 6,0"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  rename-all:
    runs-on: ubuntu-latest

    # âœ… Evite les collisions avec d'autres workflows qui pushent
    concurrency:
      group: ucflow-maintenance
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guard â€” uniquement Week-end Ã  10h Paris (schedule) / toujours OK en manuel
        if: ${{ github.event_name == 'schedule' }}
        run: |
          HOUR_PARIS=$(TZ="Europe/Paris" date +"%H")
          DOW_PARIS=$(TZ="Europe/Paris" date +"%u") # 1..7 (1=Lun, 6=Sam, 7=Dim)
          echo "Heure Paris dÃ©tectÃ©e: ${HOUR_PARIS}"
          echo "Jour semaine Paris dÃ©tectÃ©: ${DOW_PARIS}"

          # âœ… On ne garde QUE samedi(6) / dimanche(7)
          if [ "${DOW_PARIS}" -le 5 ]; then
            echo "â­ï¸ Pas le week-end â†’ stop."
            exit 0
          fi

          # âœ… On ne garde QUE 10h Paris
          if [ "${HOUR_PARIS}" != "10" ]; then
            echo "â­ï¸ Pas 10h Paris â†’ stop (run technique DST)."
            exit 0
          fi

      - name: Install image conversion tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Prepare report directory
        run: |
          mkdir -p docs/reports
          echo "# Rapport de renommage et conversion" > docs/reports/rename_report.md
          echo "GÃ©nÃ©rÃ© le $(TZ="Europe/Paris" date)" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

      - name: Rename posts + images by pairs (aligned) + PNG conversion
        run: |
          set -euo pipefail

          ###############################################
          # Date automatique = demain (base de planification)
          ###############################################
          START_DATE=$(TZ="Europe/Paris" date -d "+1 day" "+%Y-%m-%d")
          echo "Date de dÃ©part automatique : $START_DATE"
          echo "" >> docs/reports/rename_report.md
          echo "## Date de dÃ©part : $START_DATE" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # Helpers: jour ouvrÃ© + next date
          # (On planifie les fichiers sur des jours ouvrÃ©s)
          ###############################################
          next_business_day() {
            local d="$1"
            while true; do
              local dow
              dow=$(date -d "$d" +%u) # 1..7
              if [ "$dow" -le 5 ]; then
                echo "$d"
                return
              fi
              d=$(date -d "$d + 1 day" +%Y-%m-%d)
            done
          }

          next_day() {
            date -d "$1 + 1 day" +%Y-%m-%d
          }

          ###############################################
          # 1) Conversion images -> PNG (avant renommage)
          ###############################################
          echo "## Conversion des images en PNG" >> docs/reports/rename_report.md

          cd docs/images
          find . -maxdepth 1 -type f ! -name ".gitkeep" -print0 | \
          while IFS= read -r -d '' img; do
            img="${img#./}"
            ext="${img##*.}"
            base="${img%.*}"

            if [[ "$ext" =~ ^(jpg|jpeg|webp)$ ]]; then
              echo "- ðŸ–¼ï¸ Conversion : $img â†’ ${base}.png" >> ../reports/rename_report.md
              convert -- "$img" "${base}.png"
              rm -- "$img"
            fi
          done
          cd - > /dev/null
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # 2) Collecte des fichiers NON conformes
          ###############################################
          echo "## DÃ©tection des fichiers non conformes" >> docs/reports/rename_report.md

          mapfile -d '' -t POSTS < <(
            find docs/posts -maxdepth 1 -type f ! -name ".gitkeep" \
              ! -regextype posix-extended -regex '.*/[0-9]{4}-[0-9]{2}-[0-9]{2}_.*' \
              -print0 | sort -z
          )

          mapfile -d '' -t IMAGES < <(
            find docs/images -maxdepth 1 -type f ! -name ".gitkeep" \
              ! -regextype posix-extended -regex '.*/[0-9]{4}-[0-9]{2}-[0-9]{2}_.*' \
              -print0 | sort -z
          )

          echo "- ðŸ“ Posts non conformes: ${#POSTS[@]}" >> docs/reports/rename_report.md
          echo "- ðŸ–¼ï¸ Images non conformes: ${#IMAGES[@]}" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # 3) Garde-fou alignment (OBLIGATOIRE)
          ###############################################
          if [ "${#POSTS[@]}" -ne "${#IMAGES[@]}" ]; then
            echo "âŒ DÃ©salignement dÃ©tectÃ©: ${#POSTS[@]} posts vs ${#IMAGES[@]} images" >> docs/reports/rename_report.md
            echo "âž¡ï¸ Stop pour Ã©viter de casser le calendrier." >> docs/reports/rename_report.md
            echo "" >> docs/reports/rename_report.md

            echo "DÃ©tails posts:" >> docs/reports/rename_report.md
            for p in "${POSTS[@]}"; do echo "- $p" >> docs/reports/rename_report.md; done

            echo "" >> docs/reports/rename_report.md
            echo "DÃ©tails images:" >> docs/reports/rename_report.md
            for i in "${IMAGES[@]}"; do echo "- $i" >> docs/reports/rename_report.md; done

            exit 1
          fi

          if [ "${#POSTS[@]}" -eq 0 ]; then
            echo "âœ… Rien Ã  renommer (tout conforme)." >> docs/reports/rename_report.md
            exit 0
          fi

          ###############################################
          # 4) Renommage par paires (post + image)
          ###############################################
          echo "## Renommage par paires (post + image)" >> docs/reports/rename_report.md

          CURRENT_DATE="$START_DATE"
          for idx in "${!POSTS[@]}"; do
            CURRENT_DATE=$(next_business_day "$CURRENT_DATE")

            post="${POSTS[$idx]}"
            img="${IMAGES[$idx]}"

            post_name="${post##*/}"
            img_name="${img##*/}"

            target_post="docs/posts/${CURRENT_DATE}_post.txt"
            target_img="docs/images/${CURRENT_DATE}_image.png"

            while [ -f "$target_post" ] || [ -f "$target_img" ]; do
              CURRENT_DATE=$(next_day "$CURRENT_DATE")
              CURRENT_DATE=$(next_business_day "$CURRENT_DATE")
              target_post="docs/posts/${CURRENT_DATE}_post.txt"
              target_img="docs/images/${CURRENT_DATE}_image.png"
            done

            echo "- ðŸ”„ Pair $((idx+1))" >> docs/reports/rename_report.md
            echo "  - ðŸ“ $post_name â†’ ${CURRENT_DATE}_post.txt" >> docs/reports/rename_report.md
            echo "  - ðŸ–¼ï¸ $img_name â†’ ${CURRENT_DATE}_image.png" >> docs/reports/rename_report.md

            mv -- "$post" "$target_post"

            if [[ "${img##*.}" =~ ^(jpg|jpeg|webp)$ ]]; then
              tmp_png="docs/images/${img_name%.*}.png"
              convert -- "$img" "$tmp_png"
              rm -- "$img"
              mv -- "$tmp_png" "$target_img"
            else
              mv -- "$img" "$target_img"
            fi

            CURRENT_DATE=$(next_day "$CURRENT_DATE")
          done

          echo "" >> docs/reports/rename_report.md
          echo "âœ… Renommage terminÃ©." >> docs/reports/rename_report.md

      - name: Commit and push renamed files
        run: |
          set -e

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -q .; then
            git add docs/posts docs/images docs/reports/rename_report.md
            git commit -m "âœ¨ Auto-rename (pairs) weekend@10h Paris + report âœ¨"
            git push
          else
            echo "Aucun changement Ã  committer."
          fi
