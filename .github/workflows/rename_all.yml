name: Rename all posts and images (Ultimate Version)

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Date de d√©part au format YYYY-MM-DD (ex: 2025-01-13)"
        required: true
        default: "2025-01-13"

jobs:
  rename-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install image conversion tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Prepare report directory
        run: |
          mkdir -p docs/reports
          echo "# Rapport de renommage et conversion" > docs/reports/rename_report.md
          echo "G√©n√©r√© le $(date)" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

      - name: Rename posts and images using unified logic
        run: |
          set -euo pipefail

          START_DATE="${{ github.event.inputs.start_date }}"
          echo "Date de d√©part : $START_DATE"

          if ! date -d "$START_DATE" "+%Y-%m-%d" >/dev/null 2>&1; then
            echo "‚ùå Erreur : format de date invalide. Utilise YYYY-MM-DD."
            exit 1
          fi

          ###############################################
          # Fonction robuste pour renommer les fichiers
          ###############################################
          rename_files() {
            local DIR="$1"
            local PREFIX="$2"
            local EXT="$3"
            local CURRENT_DATE="$4"

            echo "## Dossier : $DIR" >> docs/reports/rename_report.md

            cd "$DIR"

            find . -maxdepth 1 -type f ! -name ".gitkeep" -print0 | \
            while IFS= read -r -d '' file; do

              file="${file#./}"

              if echo "$file" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}_'; then
                echo "- ‚è≠Ô∏è Skip (d√©j√† conforme) : $file" >> ../reports/rename_report.md
                continue
              fi

              while true; do
                DAY_OF_WEEK=$(date -d "$CURRENT_DATE" +%u)
                if [ "$DAY_OF_WEEK" -le 5 ]; then
                  break
                fi
                CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
              done

              NEW_NAME="${CURRENT_DATE}_${PREFIX}.${EXT}"

              echo "- üîÑ Renommage : $file ‚Üí $NEW_NAME" >> ../reports/rename_report.md
              mv -- "$file" "$NEW_NAME"

              CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
            done

            cd - > /dev/null
            echo "" >> docs/reports/rename_report.md
          }

          ###############################################
          # Conversion automatique des images en PNG
          ###############################################
          echo "## Conversion des images en PNG" >> docs/reports/rename_report.md

          cd docs/images

          find . -maxdepth 1 -type f ! -name ".gitkeep" -print0 | \
          while IFS= read -r -d '' img; do

            img="${img#./}"
            EXT="${img##*.}"
            BASENAME="${img%.*}"

            if [[ "$EXT" =~ ^(jpg|jpeg|webp)$ ]]; then
              echo "- üñºÔ∏è Conversion : $img ‚Üí ${BASENAME}.png" >> ../reports/rename_report.md
              convert -- "$img" "${BASENAME}.png"
              rm -- "$img"
            fi

          done

          cd - > /dev/null
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # Renommage final posts + images
          ###############################################
          rename_files "docs/posts" "post" "txt" "$START_DATE"
          rename_files "docs/images" "image" "png" "$START_DATE"

      - name: Commit and push renamed files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git diff --quiet && git diff --cached --quiet; then
            echo "Aucun changement √† committer."
            exit 0
          fi

          git add docs/posts docs/images docs/reports/rename_report.md

          COMMIT_MESSAGE="‚ú® Auto-rename posts & images + PNG conversion + report (workflow fusionn√© ultime, version robuste) ‚ú®"
          git commit -m "$COMMIT_MESSAGE"
          git push
