name: Rename all posts and images (Daily 19:00 Paris)

on:
  schedule:
    # Objectif: 19:00 heure de Paris toute lâ€™annÃ©e (DST inclus)
    # On dÃ©clenche 2 fois (UTC) + garde-fou heure Paris:
    # - 17:00 UTC => 19:00 Paris en Ã©tÃ© (UTC+2)
    # - 18:00 UTC => 19:00 Paris en hiver (UTC+1)
    - cron: "0 17 * * *"
    - cron: "0 18 * * *"

jobs:
  rename-all:
    runs-on: ubuntu-latest

    # âœ… Evite les runs simultanÃ©s (stabilitÃ©)
    concurrency:
      group: ucflow-rename-all
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Guard â€” ne sâ€™exÃ©cute quâ€™Ã  19h Paris
        run: |
          HOUR_PARIS=$(TZ="Europe/Paris" date +"%H")
          echo "Heure Paris dÃ©tectÃ©e: ${HOUR_PARIS}"
          if [ "${HOUR_PARIS}" != "19" ]; then
            echo "â­ï¸ Pas 19h Paris â†’ stop (run technique)."
            exit 0
          fi

      - name: Install image conversion tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Prepare report directory
        run: |
          mkdir -p docs/reports
          echo "# Rapport de renommage et conversion" > docs/reports/rename_report.md
          echo "GÃ©nÃ©rÃ© le $(TZ="Europe/Paris" date)" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

      - name: Rename posts + images by pairs (aligned) + PNG conversion
        run: |
          set -euo pipefail

          ###############################################
          # Date automatique = demain (base de planification)
          ###############################################
          START_DATE=$(TZ="Europe/Paris" date -d "+1 day" "+%Y-%m-%d")
          echo "Date de dÃ©part automatique : $START_DATE"
          echo "" >> docs/reports/rename_report.md
          echo "## Date de dÃ©part : $START_DATE" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # Helpers: jour ouvrÃ© + next date
          ###############################################
          next_business_day() {
            local d="$1"
            while true; do
              local dow
              dow=$(date -d "$d" +%u) # 1..7
              if [ "$dow" -le 5 ]; then
                echo "$d"
                return
              fi
              d=$(date -d "$d + 1 day" +%Y-%m-%d)
            done
          }

          next_day() {
            date -d "$1 + 1 day" +%Y-%m-%d
          }

          ###############################################
          # 1) Conversion images -> PNG (avant renommage)
          ###############################################
          echo "## Conversion des images en PNG" >> docs/reports/rename_report.md

          cd docs/images
          find . -maxdepth 1 -type f ! -name ".gitkeep" -print0 | \
          while IFS= read -r -d '' img; do
            img="${img#./}"
            ext="${img##*.}"
            base="${img%.*}"

            if [[ "$ext" =~ ^(jpg|jpeg|webp)$ ]]; then
              echo "- ðŸ–¼ï¸ Conversion : $img â†’ ${base}.png" >> ../reports/rename_report.md
              convert -- "$img" "${base}.png"
              rm -- "$img"
            fi
          done
          cd - > /dev/null
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # 2) Collecte des fichiers NON conformes
          # Conformes = commencent par YYYY-MM-DD_
          ###############################################
          echo "## DÃ©tection des fichiers non conformes" >> docs/reports/rename_report.md

          mapfile -d '' -t POSTS < <(
            find docs/posts -maxdepth 1 -type f ! -name ".gitkeep" \
              ! -regextype posix-extended -regex '.*/[0-9]{4}-[0-9]{2}-[0-9]{2}_.*' \
              -print0 | sort -z
          )

          mapfile -d '' -t IMAGES < <(
            find docs/images -maxdepth 1 -type f ! -name ".gitkeep" \
              ! -regextype posix-extended -regex '.*/[0-9]{4}-[0-9]{2}-[0-9]{2}_.*' \
              -print0 | sort -z
          )

          echo "- ðŸ“ Posts non conformes: ${#POSTS[@]}" >> docs/reports/rename_report.md
          echo "- ðŸ–¼ï¸ Images non conformes: ${#IMAGES[@]}" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # 3) Garde-fou alignment (OBLIGATOIRE)
          ###############################################
          if [ "${#POSTS[@]}" -ne "${#IMAGES[@]}" ]; then
            echo "âŒ DÃ©salignement dÃ©tectÃ©: ${#POSTS[@]} posts vs ${#IMAGES[@]} images" >> docs/reports/rename_report.md
            echo "âž¡ï¸ Stop pour Ã©viter de casser le calendrier." >> docs/reports/rename_report.md
            echo "" >> docs/reports/rename_report.md

            echo "DÃ©tails posts:" >> docs/reports/rename_report.md
            for p in "${POSTS[@]}"; do echo "- $p" >> docs/reports/rename_report.md; done

            echo "" >> docs/reports/rename_report.md
            echo "DÃ©tails images:" >> docs/reports/rename_report.md
            for i in "${IMAGES[@]}"; do echo "- $i" >> docs/reports/rename_report.md; done

            # Fail visible (pour que tu voies le problÃ¨me tout de suite)
            exit 1
          fi

          if [ "${#POSTS[@]}" -eq 0 ]; then
            echo "âœ… Rien Ã  renommer (tout conforme)." >> docs/reports/rename_report.md
            exit 0
          fi

          ###############################################
          # 4) Renommage par paires (post + image)
          ###############################################
          echo "## Renommage par paires (post + image)" >> docs/reports/rename_report.md

          CURRENT_DATE="$START_DATE"
          for idx in "${!POSTS[@]}"; do
            CURRENT_DATE=$(next_business_day "$CURRENT_DATE")

            post="${POSTS[$idx]}"
            img="${IMAGES[$idx]}"

            # Normalise les paths affichÃ©s
            post_name="${post##*/}"
            img_name="${img##*/}"

            # Cibles
            target_post="docs/posts/${CURRENT_DATE}_post.txt"
            target_img="docs/images/${CURRENT_DATE}_image.png"

            # Assure qu'on nâ€™Ã©crase rien: si date dÃ©jÃ  prise, on avance
            while [ -f "$target_post" ] || [ -f "$target_img" ]; do
              CURRENT_DATE=$(next_day "$CURRENT_DATE")
              CURRENT_DATE=$(next_business_day "$CURRENT_DATE")
              target_post="docs/posts/${CURRENT_DATE}_post.txt"
              target_img="docs/images/${CURRENT_DATE}_image.png"
            done

            echo "- ðŸ”„ Pair $((idx+1))" >> docs/reports/rename_report.md
            echo "  - ðŸ“ $post_name â†’ ${CURRENT_DATE}_post.txt" >> docs/reports/rename_report.md
            echo "  - ðŸ–¼ï¸ $img_name â†’ ${CURRENT_DATE}_image.png" >> docs/reports/rename_report.md

            mv -- "$post" "$target_post"

            # Si l'image n'est pas png (cas rÃ©siduel), on force la conversion
            if [[ "${img##*.}" =~ ^(jpg|jpeg|webp)$ ]]; then
              tmp_png="docs/images/${img_name%.*}.png"
              convert -- "$img" "$tmp_png"
              rm -- "$img"
              mv -- "$tmp_png" "$target_img"
            else
              mv -- "$img" "$target_img"
            fi

            CURRENT_DATE=$(next_day "$CURRENT_DATE")
          done

          echo "" >> docs/reports/rename_report.md
          echo "âœ… Renommage terminÃ©." >> docs/reports/rename_report.md

      - name: Commit and push renamed files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -q .; then
            git add docs/posts docs/images docs/reports/rename_report.md
            COMMIT_MESSAGE="âœ¨ Auto-rename (pairs) @19h Paris + PNG conversion + report âœ¨"
            git commit -m "$COMMIT_MESSAGE"
            git push
          else
            echo "Aucun changement Ã  committer."
          fi
