name: Rename all posts and images with dates

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Date de d√©part au format YYYY-MM-DD (ex: 2025-01-13)"
        required: true
        default: "2025-01-13"

jobs:
  rename-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Rename posts and images using unified logic
        run: |
          set -e

          START_DATE="${{ github.event.inputs.start_date }}"
          echo "Date de d√©part : $START_DATE"

          # V√©rification du format de date
          if ! date -d "$START_DATE" "+%Y-%m-%d" >/dev/null 2>&1; then
            echo "‚ùå Erreur : format de date invalide. Utilise YYYY-MM-DD."
            exit 1
          fi

          ###############################################
          # Fonction Bash factoris√©e pour renommer
          ###############################################
          rename_files() {
            local DIR="$1"
            local PREFIX="$2"
            local EXT="$3"
            local CURRENT_DATE="$4"

            echo "üìÅ Traitement du dossier : $DIR"
            cd "$DIR"

            FILES=($(ls -1))

            for file in "${FILES[@]}"; do
              # Ignorer .gitkeep
              if [[ "$file" == ".gitkeep" ]]; then
                continue
              fi

              # Ignorer les fichiers d√©j√† au bon format
              if echo "$file" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}_'; then
                echo "‚è≠Ô∏è  Skip (d√©j√† conforme) : $file"
                continue
              fi

              # Sauter les week-ends
              while true; do
                DAY_OF_WEEK=$(date -d "$CURRENT_DATE" +%u)
                if [ "$DAY_OF_WEEK" -le 5 ]; then
                  break
                fi
                CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
              done

              NEW_NAME="${CURRENT_DATE}_${PREFIX}.${EXT}"
              echo "üîÑ Renommage : $file ‚Üí $NEW_NAME"
              mv "$file" "$NEW_NAME"

              CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
            done

            cd - > /dev/null
          }

          ###############################################
          # Appels de la fonction pour posts + images
          ###############################################

          rename_files "docs/posts" "post" "txt" "$START_DATE"
          rename_files "docs/images" "image" "png" "$START_DATE"

      - name: Commit and push renamed files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git diff --quiet && git diff --cached --quiet; then
            echo "Aucun changement √† committer."
            exit 0
          fi

          git add docs/posts docs/images

          COMMIT_MESSAGE="‚ú® Auto-rename posts & images to YYYY-MM-DD_* (workflow fusionn√©) ‚ú®"
          git commit -m "$COMMIT_MESSAGE"
          git push
