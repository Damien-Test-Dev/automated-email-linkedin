name: Rename all posts and images (Automatic Daily Version)

on:
  schedule:
    # Tous les jours du lundi au vendredi Ã  08:00 UTC
    # = 09:00 Paris (hiver) / 10:00 Paris (Ã©tÃ©)
    - cron: "0 8 * * 1-5"

jobs:
  rename-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install image conversion tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Prepare report directory
        run: |
          mkdir -p docs/reports
          echo "# Rapport de renommage et conversion" > docs/reports/rename_report.md
          echo "GÃ©nÃ©rÃ© le $(date)" >> docs/reports/rename_report.md
          echo "" >> docs/reports/rename_report.md

      - name: Rename posts and images using unified logic
        run: |
          set -euo pipefail

          ###############################################
          # Date automatique = demain
          ###############################################
          START_DATE=$(date -d "+1 day" "+%Y-%m-%d")
          echo "Date de dÃ©part automatique : $START_DATE"

          ###############################################
          # Fonction robuste pour renommer les fichiers
          ###############################################
          rename_files() {
            local DIR="$1"
            local PREFIX="$2"
            local EXT="$3"
            local CURRENT_DATE="$4"

            echo "## Dossier : $DIR" >> docs/reports/rename_report.md

            cd "$DIR"

            find . -maxdepth 1 -type f ! -name ".gitkeep" -print0 | \
            while IFS= read -r -d '' file; do

              file="${file#./}"

              # DÃ©jÃ  conforme â†’ skip
              if echo "$file" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}_'; then
                echo "- â­ï¸ Skip (dÃ©jÃ  conforme) : $file" >> ../reports/rename_report.md
                continue
              fi

              # Sauter les week-ends
              while true; do
                DAY_OF_WEEK=$(date -d "$CURRENT_DATE" +%u)
                if [ "$DAY_OF_WEEK" -le 5 ]; then
                  break
                fi
                CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
              done

              NEW_NAME="${CURRENT_DATE}_${PREFIX}.${EXT}"

              echo "- ðŸ”„ Renommage : $file â†’ $NEW_NAME" >> ../reports/rename_report.md
              mv -- "$file" "$NEW_NAME"

              CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
            done

            cd - > /dev/null
            echo "" >> docs/reports/rename_report.md
          }

          ###############################################
          # Conversion automatique des images en PNG
          ###############################################
          echo "## Conversion des images en PNG" >> docs/reports/rename_report.md

          cd docs/images

          find . -maxdepth 1 -type f ! -name ".gitkeep" -print0 | \
          while IFS= read -r -d '' img; do

            img="${img#./}"
            EXT="${img##*.}"
            BASENAME="${img%.*}"

            if [[ "$EXT" =~ ^(jpg|jpeg|webp)$ ]]; then
              echo "- ðŸ–¼ï¸ Conversion : $img â†’ ${BASENAME}.png" >> ../reports/rename_report.md
              convert -- "$img" "${BASENAME}.png"
              rm -- "$img"
            fi

          done

          cd - > /dev/null
          echo "" >> docs/reports/rename_report.md

          ###############################################
          # Renommage final posts + images
          ###############################################
          rename_files "docs/posts" "post" "txt" "$START_DATE"
          rename_files "docs/images" "image" "png" "$START_DATE"

      - name: Commit and push renamed files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git diff --quiet && git diff --cached --quiet; then
            echo "Aucun changement Ã  committer."
            exit 0
          fi

          git add docs/posts docs/images docs/reports/rename_report.md

          COMMIT_MESSAGE="âœ¨ Auto-rename posts & images (daily cron) + PNG conversion + report âœ¨"
          git commit -m "$COMMIT_MESSAGE"
          git push
