name: Daily Report

on:
  schedule:
    - cron: "30 8 * * 1-5"  # chaque jour ouvré à 08:30
  workflow_dispatch:

jobs:
  daily_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Generate daily report
        run: |
          python generate_daily_report.py

      - name: Show report summary
        run: |
          echo "## Daily Report Summary" >> $GITHUB_STEP_SUMMARY
          today=$(date +'%Y-%m-%d')
          report="reports/daily_report_${today}.md"
          if [ -f "$report" ]; then
            echo "Rapport généré : $report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            head -n 20 "$report" >> $GITHUB_STEP_SUMMARY
          else
            echo "Aucun rapport généré." >> $GITHUB_STEP_SUMMARY

      - name: Cleanup old reports (older than 365 days)
        run: |
          echo "Nettoyage des rapports de plus de 365 jours..."
          if [ -d "reports" ]; then
            find reports -type f -name "daily_report_*.md" -mtime +365 -print -delete
          else
            echo "Le dossier reports/ n'existe pas encore, rien à nettoyer."
          fi

      - name: Commit and push report
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add reports
          git commit -m "Daily report generated + cleanup old reports" || echo "Aucun changement"
          git push || echo "Aucun changement"
