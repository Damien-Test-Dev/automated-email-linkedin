name: Rename image files with dates

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Date de départ au format YYYY-MM-DD (ex: 2025-01-13)"
        required: true
        default: "2025-01-13"

jobs:
  rename-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List current files in /docs/images
        run: |
          echo "Fichiers actuels dans /docs/images :"
          ls -la docs/images || echo "Aucun dossier docs/images trouvé"

      - name: Rename raw image files to YYYY-MM-DD_image.png (weekdays only)
        run: |
          set -e

          START_DATE="${{ github.event.inputs.start_date }}"
          echo "Date de départ fournie : $START_DATE"

          if ! date -d "$START_DATE" "+%Y-%m-%d" >/dev/null 2>&1; then
            echo "Erreur : format de date invalide. Utilise YYYY-MM-DD."
            exit 1
          fi

          cd docs/images

          echo "Fichiers trouvés dans /docs/images avant filtrage :"
          ls -1

          RAW_FILES=()
          while IFS= read -r file; do
            if [ "$file" = ".gitkeep" ]; then
              continue
            fi
            if echo "$file" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}_image\.(png|jpg|jpeg|webp)$'; then
              echo "Skip (déjà au bon format) : $file"
              continue
            fi
            RAW_FILES+=("$file")
          done < <(ls -1)

          echo "Fichiers à renommer : ${RAW_FILES[*]}"

          CURRENT_DATE="$START_DATE"

          for file in "${RAW_FILES[@]}"; do
            while true; do
              DAY_OF_WEEK=$(date -d "$CURRENT_DATE" +%u)
              if [ "$DAY_OF_WEEK" -le 5 ]; then
                break
              fi
              CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
            done

            EXT="${file##*.}"
            NEW_NAME="${CURRENT_DATE}_image.${EXT}"

            echo "Renommage : $file  ->  $NEW_NAME"
            mv "$file" "$NEW_NAME"

            CURRENT_DATE=$(date -d "$CURRENT_DATE + 1 day" +%Y-%m-%d)
          done

          echo "Fichiers finaux dans /docs/images :"
          ls -1

      - name: Commit and push renamed files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git status

          if git diff --quiet && git diff --cached --quiet; then
            echo "Aucun changement à committer."
            exit 0
          fi

          git add docs/images

          COMMIT_MESSAGE="⭐ Auto-rename image files in docs/images to YYYY-MM-DD_image.png ⭐"
          git commit -m "$COMMIT_MESSAGE"
          git push
